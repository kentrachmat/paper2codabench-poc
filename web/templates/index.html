<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper2Codabench - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <div class="container">
            <h1>Paper to Codabench</h1>
            <p class="subtitle">Upload a research paper and watch AI generate a Codabench bundle</p>
        </div>
    </header>

    <main class="container">
        <!-- Upload Section -->
        <section class="upload-section">
            <div class="upload-card">
                <h2>Upload Research Paper</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="file-upload">
                        <input type="file" id="paperFile" name="paper" accept=".pdf" required>
                        <label for="paperFile" class="file-label">
                            <span id="fileName">Choose PDF file...</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-large">Start Processing</button>
                </form>
            </div>
        </section>

        <!-- Processing Progress Section -->
        <section id="progressSection" class="progress-section" style="display: none;">
            <div class="progress-card">
                <h2 id="progressTitle">AI Processing Status</h2>
                <div id="progressSteps">
                    <div class="progress-step" data-step="upload">
                        <div class="step-icon">PDF</div>
                        <div class="step-content">
                            <div class="step-title">Paper Upload</div>
                            <div class="step-status">Waiting...</div>
                        </div>
                    </div>
                    <div class="progress-step" data-step="extract">
                        <div class="step-icon">AI</div>
                        <div class="step-content">
                            <div class="step-title">Extracting Croissant Task</div>
                            <div class="step-status">Analyzing paper structure and task details...</div>
                        </div>
                    </div>
                    <div class="progress-step" data-step="generate">
                        <div class="step-icon">GEN</div>
                        <div class="step-content">
                            <div class="step-title">Generating Bundle</div>
                            <div class="step-status">Creating evaluation code, solution template, and test data...</div>
                        </div>
                    </div>
                    <div class="progress-step" data-step="complete">
                        <div class="step-icon">OK</div>
                        <div class="step-content">
                            <div class="step-title">Complete</div>
                            <div class="step-status">Bundle ready for download</div>
                        </div>
                    </div>
                </div>
                <div id="progressDetails" class="progress-details"></div>

                <!-- Terminal Output -->
                <div class="terminal-output">
                    <div class="terminal-header">
                        <span class="terminal-title">Terminal Output</span>
                    </div>
                    <div id="terminalConsole" class="terminal-console">
                        <div class="terminal-line">Waiting for output...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="resultsSection" class="results-section" style="display: none;">
            <div class="results-card">
                <h2>Processing Complete!</h2>
                <div id="resultsContent"></div>
                <div class="results-actions">
                    <button onclick="location.reload()" class="btn btn-secondary">Process Another Paper</button>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>Paper2Codabench - Exploring automated reproducibility verification</p>
        </div>
    </footer>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const paperFile = document.getElementById('paperFile');
        const fileName = document.getElementById('fileName');
        const progressSection = document.getElementById('progressSection');
        const resultsSection = document.getElementById('resultsSection');

        paperFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileName.textContent = e.target.files[0].name;
            }
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('paper', paperFile.files[0]);

            progressSection.style.display = 'block';
            uploadForm.parentElement.style.display = 'none';

            updateStep('upload', 'active', 'Uploading...');

            try {
                const response = await fetch('/api/process_paper', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                const data = await response.json();
                updateStep('upload', 'complete', 'Upload complete');

                pollProgress(data.paper_id);

            } catch (error) {
                updateStep('upload', 'error', 'Upload failed: ' + error.message);
            }
        });

        function updateStep(step, status, message) {
            const stepEl = document.querySelector(`.progress-step[data-step="${step}"]`);
            if (stepEl) {
                stepEl.className = `progress-step status-${status}`;
                const statusEl = stepEl.querySelector('.step-status');
                if (statusEl && message) {
                    statusEl.textContent = message;
                }
            }
        }

        async function pollProgress(paperId) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/progress/${paperId}`);
                    const data = await response.json();

                    if (data.croissant_extracted) {
                        updateStep('extract', 'complete', 'Croissant Task extracted successfully');
                    } else if (data.extracting) {
                        updateStep('extract', 'active', 'Analyzing paper with AI...');
                    }

                    if (data.bundle_generated) {
                        updateStep('generate', 'complete', 'Bundle generated successfully');
                        updateStep('complete', 'complete', 'Ready!');
                        clearInterval(pollInterval);
                        showResults(data);
                    } else if (data.generating) {
                        updateStep('generate', 'active', 'Generating evaluation code...');
                    }

                    if (data.details) {
                        document.getElementById('progressDetails').innerHTML =
                            `<div class="detail-item">${data.details}</div>`;
                    }

                    if (data.terminal_output && data.terminal_output.length > 0) {
                        const terminalConsole = document.getElementById('terminalConsole');
                        terminalConsole.innerHTML = data.terminal_output
                            .map(line => `<div class="terminal-line">${escapeHtml(line)}</div>`)
                            .join('');
                        terminalConsole.scrollTop = terminalConsole.scrollHeight;
                    }

                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 1000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showResults(data) {
            document.getElementById('progressTitle').textContent = 'Processing Complete';

            resultsSection.style.display = 'block';

            const content = `
                <div class="result-summary">
                    <h3>${data.task_name || 'Task'}</h3>
                    <p><strong>Metric:</strong> ${data.primary_metric || 'N/A'}</p>
                    <p><strong>Files generated:</strong> ${data.file_count || 0}</p>
                </div>
                <div class="result-actions">
                    <a href="/croissant/${data.paper_id}" class="btn btn-primary">View Croissant Task</a>
                    <a href="/bundle/${data.paper_id}" class="btn btn-primary">View Bundle</a>
                </div>
            `;
            document.getElementById('resultsContent').innerHTML = content;
        }
    </script>
</body>
</html>
